<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Portal</title> 

    <script type='module' src='https://prod-in-a.online.tableau.com/javascripts/api/tableau.embedding.3.latest.min.js'></script>

    <style>
        /* Basic page styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        /* --- Sticky Header --- */
        #sticky-header {
            position: sticky;
            top: 0;
            z-index: 1001; /* Higher than dropdown */
        }

        /* Filter pane styles */
        .toggle-button {
            background-color: #FA8072; /* Salmon pink */
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            text-align: left;
            border-radius: 0; 
        }

        .toggle-button:hover {
            background-color: #CD5C5C; /* Darker red */
        }
        
        .filter-pane {
            background-color: #ffffff;
            padding: 20px;
            border-bottom: 2px solid #ddd;
            display: none; /* Starts closed by default */
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        /* Grouping for Parameters */
        .param-group-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            flex-basis: 100%; 
        }

        .param-sub-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
        }
        
        .control-group label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #555;
        }

        /* --- Checkbox Dropdown Styles --- */
        .dropdown {
            position: relative;
        }
        
        .dropdown-button {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            width: 100%;
            text-align: left;
            box-sizing: border-box; 
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 250px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .dropdown-content label {
            display: block;
            padding: 5px 10px;
            font-weight: normal;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        .dropdown-content label:hover {
            background-color: #f0f0f0;
        }
        
        .dropdown-content label input {
            margin-right: 8px;
        }
        /* ------------------------------------- */

        .control-group input[type="date"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1em;
            box-sizing: border-box; 
        }

        .control-group.checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }
        
        .control-group.checkbox-group input {
            margin-right: 8px;
        }

        .clear-button {
            padding: 8px 15px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            align-self: flex-end;
        }
        
        .clear-button:hover {
            background-color: #c9302c;
        }

        /* --- Sizing Container --- */
        .viz-wrapper {
            width: 100%;
            height: 800px; /* Set fixed height on the WRAPPER */
            box-sizing: border-box;
        }

        tableau-viz {
            display: block; 
            width: 100%;
            height: 100%; /* Tell viz to fill its wrapper */
            box-sizing: border-box;
        }
        
        .viz-separator {
            border: none;
            height: 0.5cm;
            background-color: #000; /* Black */
            margin: 20px 0; /* Add vertical space */
        }
    </style>
</head>
<body>

    <div id="sticky-header">
        <button id="toggle-filter-btn" class="toggle-button">☰ Page Filters</button>
        
        <div id="filter-pane" class="filter-pane">
            <div class="controls-container">
                <div class="control-group">
                    <label>Branch</label>
                    <div class="dropdown filter-group" data-field-name="Clean Branch Name">
                        <button class="dropdown-button">Select Branch(es)</button>
                        <div class="dropdown-content">
                            <label><input type="checkbox" value="All" class="filter-all-cb" /> (All)</label>
                            <label><input type="checkbox" value="AUNDH RETAIL STORE" /> AUNDH RETAIL STORE</label>
                            <label><input type="checkbox" value="FOOD COUNTER GUREGHAR" /> FOOD COUNTER GUREGHAR</label>
                            <label><input type="checkbox" value="FOOD COUNTER LONAVALA" /> FOOD COUNTER LONAVALA</label>
                            <label><input type="checkbox" value="FOOD COUNTER SHENDURJANE" /> FOOD COUNTER SHENDURJANE</label>
                            <label><input type="checkbox" value="MAPRO FACTORY TOUR & ADVENTURE PARK" /> MAPRO FACTORY TOUR & ADVENTURE PARK</label>
                            <label><input type="checkbox" value="MAPRO MANISHA GARDEN GUREGHAR" /> MAPRO MANISHA GARDEN GUREGHAR</label>
                            <label><input type="checkbox" value="ONLINE SALES WAREHOUSE" /> ONLINE SALES WAREHOUSE</label>
                            <label><input type="checkbox" value="PST, HIGHWAY AND MAHABALESHWAR MARKET" /> PST, HIGHWAY AND MAHABALESHWAR MARKET</label>
                            <label><input type="checkbox" value="Retail Drive Inn" /> Retail Drive Inn</label>
                            <label><input type="checkbox" value="Retail Gureghar" /> Retail Gureghar</label>
                            <label><input type="checkbox" value="Retail Gureghar WH" /> Retail Gureghar WH</label>
                            <label><input type="checkbox" value="Retail Lonavala" /> Retail Lonavala</label>
                            <label><input type="checkbox" value="Retail Online" /> Retail Online</label>
                            <label><input type="checkbox" value="Retail Shendurjane" /> Retail Shendurjane</label>
                            <label><input type="checkbox" value="TBT STORE GUREGHAR" /> TBT STORE GUREGHAR</label>
                            <label><input type="checkbox" value="TBT STORE VALVAN LONAVALA" /> TBT STORE VALVAN LONAVALA</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Category</label>
                    <div class="dropdown filter-group" data-field-name="Category">
                        <button class="dropdown-button">Select Category(s)</button>
                        <div class="dropdown-content">
                            <label><input type="checkbox" value="All" class="filter-all-cb" /> (All)</label>
                            <label><input type="checkbox" value="CAFERO" /> CAFERO</label>
                            <label><input type="checkbox" value="CHOCOLATE" /> CHOCOLATE</label>
                            <label><input type="checkbox" value="FALERO AND FRUIT CHEWS" /> FALERO AND FRUIT CHEWS</label>
                            <label><input type="checkbox" value="FOOD COUNTER" /> FOOD COUNTER</label>
                            <label><input type="checkbox" value="FRUIT FILLINGS" /> FRUIT FILLINGS</label>
                            <label><input type="checkbox" value="HAMPERS" /> HAMPERS</label>
                            <label><input type="checkbox" value="JAMS AND SPREADS" /> JAMS AND SPREADS</label>
                            <label><input type="checkbox" value="KHAKHRA" /> KHAKHRA</label>
                            <label><input type="checkbox" value="LOUNGE" /> LOUNGE</label>
                            <label><input type="checkbox" value="OTHER" /> OTHER</label>
                            <label><input type="checkbox" value="PACKAGING MATERIAL" /> PACKAGING MATERIAL</label>
                            <label><input type="checkbox" value="PERSONAL CARE" /> PERSONAL CARE</label>
                            <label><input type="checkbox" value="PRA SHARBATS AND SYRUPS" /> PRA SHARBATS AND SYRUPS</label>
                            <label><input type="checkbox" value="SCS" /> SCS</label>
                            <label><input type="checkbox" value="SNACKERY" /> SNACKERY</label>
                            <label><input type="checkbox" value="TRADING" /> TRADING</label>
                            <label><input type="checkbox" value="ZERO SUGAR" /> ZERO SUGAR</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Subcategory</label>
                    <div class="dropdown filter-group" data-field-name="Subcategory">
                        <button class="dropdown-button">Select Subcategory(s)</button>
                        <div class="dropdown-content">
                            <label><input type="checkbox" value="All" class="filter-all-cb" /> (All)</label>
                            <label><input type="checkbox" value="ADVENTURE PARK" /> ADVENTURE PARK</label>
                            <label><input type="checkbox" value="BANANA CHIPS" /> BANANA CHIPS</label>
                            <label><input type="checkbox" value="CAFREO" /> CAFREO</label>
                            <label><input type="checkbox" value="CHOCO SPREAD" /> CHOCO SPREAD</label>
                            <label><input type="checkbox" value="CHOCOLATE" /> CHOCOLATE</label>
                            <label><input type="checkbox" value="CHOCOLATE BARS" /> CHOCOLATE BARS</label>
                            <label><input type="checkbox" value="CHOCOLATE COATED NUTS" /> CHOCOLATE COATED NUTS</label>
                            <label><input type="checkbox" value="CHOCOLATE COMBI PACK" /> CHOCOLATE COMBI PACK</label>
                            <label><input type="checkbox" value="CHOCOLATE DRAGEE" /> CHOCOLATE DRAGEE</label>
                            <label><input type="checkbox" value="CHOCOLATE GIFT PACK" /> CHOCOLATE GIFT PACK</label>
                            <label><input type="checkbox" value="CHOCOLATE NUTS" /> CHOCOLATE NUTS</label>
                            <label><input type="checkbox" value="CHOCOLATE STANDEE POUCH" /> CHOCOLATE STANDEE POUCH</label>
                            <label><input type="checkbox" value="CHOCOLERO" /> CHOCOLERO</label>
                            <label><input type="checkbox" value="COFFEE FLAVOUR" /> COFFEE FLAVOUR</label>
                            <label><input type="checkbox" value="COOKIES" /> COOKIES</label>
                            <label><input type="checkbox" value="COOKIES HAMPER" /> COOKIES HAMPER</label>
                            <label><input type="checkbox" value="COOLIO 500G" /> COOLIO 500G</label>
                            <label><input type="checkbox" value="COSMETICS" /> COSMETICS</label>
                            <label><input type="checkbox" value="Cotton Bag" /> Cotton Bag</label>
                            <label><input type="checkbox" value="CRUSHES" /> CRUSHES</label>
                            <label><input type="checkbox" value="CRUSHES COMBI PACK" /> CRUSHES COMBI PACK</label>
                            <label><input type="checkbox" value="CUBES" /> CUBES</label>
                            <label><input type="checkbox" value="CUBES HAMPER" /> CUBES HAMPER</label>
                            <label><input type="checkbox" value="DESSERT" /> DESSERT</label>
                            <label><input type="checkbox" value="DIWALI HAMPER" /> DIWALI HAMPER</label>
                            <label><input type="checkbox" value="DRINKS" /> DRINKS</label>
                            <label><input type="checkbox" value="DRIVER DHABA" /> DRIVER DHABA</label>
                            <label><input type="checkbox" value="FACTORY TOUR" /> FACTORY TOUR</label>
                            <label><input type="checkbox" value="FALCHOOS" /> FALCHOOS</label>
                            <label><input type="checkbox" value="FALCHOOS HAMPER" /> FALCHOOS HAMPER</label>
                            <label><input type="checkbox" value="FALERO" /> FALERO</label>
                            <label><input type="checkbox" value="FALERO COMBI PACK" /> FALERO COMBI PACK</label>
                            <label><input type="checkbox" value="FALERO DRINK COMBI" /> FALERO DRINK COMBI</label>
                            <label><input type="checkbox" value="FALERO HAMPER" /> FALERO HAMPER</label>
                            <label><input type="checkbox" value="FALERO RAIN FALL" /> FALERO RAIN FALL</label>
                            <label><input type="checkbox" value="FALERO SPARKY" /> FALERO SPARKY</label>
                            <label><input type="checkbox" value="FLAG CAPS" /> FLAG CAPS</label>
                            <label><input type="checkbox" value="FRENCH FRY" /> FRENCH FRY</label>
                            <label><input type="checkbox" value="FRUBA" /> FRUBA</label>
                            <label><input type="checkbox" value="FRUBBLE" /> FRUBBLE</label>
                            <label><input type="checkbox" value="FRUBBLE COMBI PACK" /> FRUBBLE COMBI PACK</label>
                            <label><input type="checkbox" value="FRUBBLE FRUIT SNACK" /> FRUBBLE FRUIT SNACK</label>
                            <label><input type="checkbox" value="FRUDIP" /> FRUDIP</label>
                            <label><input type="checkbox" value="FRUIT AND VEGITABLE" /> FRUIT AND VEGITABLE</label>
                            <label><input type="checkbox" value="FRUIT FILLINGS" /> FRUIT FILLINGS</label>
                            <label><input type="checkbox" value="FRUITY SWEETS AND OTHERS" /> FRUITY SWEETS AND OTHERS</label>
                            <label><input type="checkbox" value="FRUITY SWEETS HAMPER" /> FRUITY SWEETS HAMPER</label>
                            <label><input type="checkbox" value="GHEE" /> GHEE</label>
                            <label><input type="checkbox" value="GIFT HAMPER" /> GIFT HAMPER</label>
                            <label><input type="checkbox" value="GIFT ITEMS" /> GIFT ITEMS</label>
                            <label><input type="checkbox" value="GOAT HAMPER" /> GOAT HAMPER</label>
                            <label><input type="checkbox" value="GOLIO SPARK" /> GOLIO SPARK</label>
                            <label><input type="checkbox" value="GREETINGS HAMPER" /> GREETINGS HAMPER</label>
                            <label><input type="checkbox" value="GULKAND" /> GULKAND</label>
                            <label><input type="checkbox" value="HONEY" /> HONEY</label>
                            <label><input type="checkbox" value="ICE CREAM" /> ICE CREAM</label>
                            <label><input type="checkbox" value="JAGGERY" /> JAGGERY</label>
                            <label><input type="checkbox" value="JAM" /> JAM</label>
                            <label><input type="checkbox" value="JAM AND KETCHUP COMBI" /> JAM AND KETCHUP COMBI</label>
                            <label><input type="checkbox" value="J-POP" /> J-POP</label>
                            <label><input type="checkbox" value="KETCHUP" /> KETCHUP</label>
                            <label><input type="checkbox" value="KHAKHRA" /> KHAKHRA</label>
                            <label><input type="checkbox" value="LOUNGE" /> LOUNGE</label>
                            <label><input type="checkbox" value="MAPRO HAMPER" /> MAPRO HAMPER</label>
                            <label><input type="checkbox" value="MAZAANA HAMPER" /> MAZAANA HAMPER</label>
                            <label><input type="checkbox" value="MIX HAMPER" /> MIX HAMPER</label>
                            <label><input type="checkbox" value="MIXOLOGY KIT" /> MIXOLOGY KIT</label>
                            <label><input type="checkbox" value="NACHOS" /> NACHOS</label>
                            <label><input type="checkbox" value="OTHER" /> OTHER</label>
                            <label><input type="checkbox" value="OTHER TRADING" /> OTHER TRADING</label>
                            <label><input type="checkbox" value="PAANDE" /> PAANDE</label>
                            <label><input type="checkbox" value="PACKAGING MATERIAL" /> PACKAGING MATERIAL</label>
                            <label><input type="checkbox" value="PACKING BAG" /> PACKING BAG</label>
                            <label><input type="checkbox" value="PEANUT BUTTER" /> PEANUT BUTTER</label>
                            <label><input type="checkbox" value="PIZZA" /> PIZZA</label>
                            <label><input type="checkbox" value="PIZZA SAUCE" /> PIZZA SAUCE</label>
                            <label><input type="checkbox" value="PLANTS SALES" /> PLANTS SALES</label>
                            <label><input type="checkbox" value="PONCHO" /> PONCHO</label>
                            <label><input type="checkbox" value="PRA PRESERVE" /> PRA PRESERVE</label>
                            <label><input type="checkbox" value="PRA SHARBATS" /> PRA SHARBATS</label>
                            <label><input type="checkbox" value="PRA SYRUPS" /> PRA SYRUPS</label>
                            <label><input type="checkbox" value="PRALINES" /> PRALINES</label>
                            <label><input type="checkbox" value="RAKSHABANDHAN HAMPER" /> RAKSHABANDHAN HAMPER</label>
                            <label><input type="checkbox" value="RTD" /> RTD</label>
                            <label><input type="checkbox" value="RTD COMBI" /> RTD COMBI</label>
                            <label><input type="checkbox" value="SANDWICH & SOUP" /> SANDWICH & SOUP</label>
                            <label><input type="checkbox" value="SHAMPOO" /> SHAMPOO</label>
                            <label><input type="checkbox" value="SHIPING CHARGES" /> SHIPING CHARGES</label>
                            <label><input type="checkbox" value="SKIN CARE" /> SKIN CARE</label>
                            <label><input type="checkbox" value="SOAP" /> SOAP</label>
                            <label><input type="checkbox" value="SPA" /> SPA</label>
                            <label><input type="checkbox" value="SPARKY COMBO" /> SPARKY COMBO</label>
                            <label><input type="checkbox" value="SPICE DROPS" /> SPICE DROPS</label>
                            <label><input type="checkbox" value="SQUASH COMBI" /> SQUASH COMBI</label>
                            <label><input type="checkbox" value="SQUASHES" /> SQUASHES</label>
                            <label><input type="checkbox" value="SUGAR" /> SUGAR</label>
                            <label><input type="checkbox" value="Syrups" /> Syrups</label>
                            <label><input type="checkbox" value="SYRUPS COMBI" /> SYRUPS COMBI</label>
                            <label><input type="checkbox" value="SYRUPS HAMPER" /> SYRUPS HAMPER</label>
                            <label><input type="checkbox" value="TOPPINGS" /> TOPPINGS</label>
                            <label><input type="checkbox" value="TRADING" /> TRADING</label>
                            <label><input type="checkbox" value="UMBRELLA" /> UMBRELLA</label>
                            <label><input type="checkbox" value="WATER BOTTLE" /> WATER BOTTLE</label>
                            <label><input type="checkbox" value="White Mug" /> White Mug</label>
                            <label><input type="checkbox" value="WIRE BAG" /> WIRE BAG</label>
                            <label><input type="checkbox" value="ZERO ADDED CHOCOLATE" /> ZERO ADDED CHOCOLATE</label>
                            <label><input type="checkbox" value="ZERO ADDED PRESERVE" /> ZERO ADDED PRESERVE</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Brand</label>
                    <div class="dropdown filter-group" data-field-name="brand">
                        <button class="dropdown-button">Select Brand(s)</button>
                        <div class="dropdown-content">
                            <label><input type="checkbox" value="All" class="filter-all-cb" /> (All)</label>
                            <label><input type="checkbox" value="FALERO" /> FALERO</label>
                            <label><input type="checkbox" value="FOOD COUNTER" /> FOOD COUNTER</label>
                            <label><input type="checkbox" value="LOUNGE" /> LOUNGE</label>
                            <label><input type="checkbox" value="MAPRO" /> MAPRO</label>
                            <label><input type="checkbox" value="MAZAANA" /> MAZAANA</label>
                            <label><input type="checkbox" value="NA" /> NA</label>
                            <label><input type="checkbox" value="OTHER" /> OTHER</label>
                            <label><input type="checkbox" value="PRA" /> PRA</label>
                            <label><input type="checkbox" value="SNACKERY" /> SNACKERY</label>
                            <label><input type="checkbox" value="TBT" /> TBT</label>
                            <label><input type="checkbox" value="TRADING GOODS" /> TRADING GOODS</label>
                            <label><input type="checkbox" value="WHITTY" /> WHITTY</label>
                        </div>
                    </div>
                </div>

                <div class="param-group-container">
                    <div class="control-group checkbox-group">
                        <label>
                            <input type="checkbox" class="param-change" data-param-name="Use Custom Range?">
                            Use Custom Date Range
                        </label>
                    </div>
                    <div class="param-sub-group">
                        <div class="control-group">
                            <label for="custom-ty-start">Custom TY Start</label>
                            <input type="date" id="custom-ty-start" class="param-change" data-param-name="Custom Range Start">
                        </div>
                        <div class="control-group">
                            <label for="custom-ty-end">Custom TY End</label>
                            <input type="date" id="custom-ty-end" class="param-change" data-param-name="Custom Range End">
                        </div>
                        <div class="control-group">
                            <label for="custom-ly-start">Custom LY Start</label>
                            <input type="date" id="custom-ly-start" class="param-change" data-param-name="Custom Comparison Start">
                        </div>
                        <div class="control-group">
                            <label for="custom-ly-end">Custom LY End</label>
                            <input type="date" id="custom-ly-end" class="param-change" data-param-name="Custom Comparison End">
                        </div>
                    </div>
                </div>

                <div class="param-group-container">
                    <div class="control-group checkbox-group">
                        <label>
                            <input type="checkbox" class="param-change" data-param-name="Use Manual Date?">
                            Use Manual Analysis Start Point
                        </label>
                    </div>
                    <div class="param-sub-group">
                        <div class="control-group">
                            <label for="manual-analysis-start">Manual Analysis Start Point</label>
                            <input type="date" id="manual-analysis-start" class="param-change" data-param-name="Manual Analysis Date">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>&nbsp;</label> <button id="clear-all-btn" class="clear-button">Clear All Filters</button>
                </div>
            </div>
        </div>
    </div> <div class="viz-wrapper">
        <tableau-viz 
            id="viz1"
            src="https://prod-in-a.online.tableau.com/t/vikasg-ae2111f8b2/views/MGdahsboardV3/ExecutiveSummary"
            toolbar="hidden" 
            hide-tabs>
        </tableau-viz>
    </div>

    <hr class="viz-separator">

    <div class="viz-wrapper">
        <tableau-viz 
            id="viz2"
            src="https://prod-in-a.online.tableau.com/t/vikasg-ae2111f8b2/views/ExecutiveSummary2/Executive2"
            toolbar="hidden" 
            hide-tabs>
        </tableau-viz>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
        
            // --- Element references ---
            const viz1 = document.getElementById("viz1");
            const viz2 = document.getElementById("viz2");
        
            let vizObj1 = null;
            let vizObj2 = null;
            let viz1Ready = false;
            let viz2Ready = false;
        
            const filterPane = document.getElementById("filter-pane");
            const toggleButton = document.getElementById("toggle-filter-btn");
            const clearAllButton = document.getElementById("clear-all-btn");
            const allFilterGroups = document.querySelectorAll(".filter-group");
            const allParamInputs = document.querySelectorAll(".param-change");
            const allDropdownButtons = document.querySelectorAll(".dropdown-button");
        
            // --- Toggle Filter Pane ---
            toggleButton.addEventListener("click", () => {
                const isHidden = filterPane.style.display === "none";
                filterPane.style.display = isHidden ? "block" : "none";
                // CHANGED: Updated text logic
                toggleButton.textContent = isHidden ? "X Close" : "☰ Page Filters";
            });
        
            // --- Dropdown logic ---
            allDropdownButtons.forEach(button => {
                button.addEventListener("click", (e) => {
                    allDropdownButtons.forEach(btn => {
                        if (btn !== button) btn.nextElementSibling.style.display = "none";
                    });
                    const content = button.nextElementSibling;
                    content.style.display = content.style.display === "block" ? "none" : "block";
                    e.stopPropagation();
                });
            });
        
            document.querySelectorAll(".dropdown-content").forEach(content => {
                content.addEventListener("click", e => e.stopPropagation());
            });
        
            document.addEventListener("click", () => {
                document.querySelectorAll(".dropdown-content").forEach(c => c.style.display = "none");
            });
        
            // ------------------------------------------------------------------
            // ---------------------- FILTER HANDLING ----------------------------
            // ------------------------------------------------------------------
        
            async function applyToDashboardWorksheets(workbookObj, fieldName, values, updateType) {
                try {
                    const dashboard = workbookObj.activeSheet;
                    const worksheets = dashboard.worksheets; 
                    console.log(`...Applying filter to ${worksheets.length} sheets on dashboard ${dashboard.name}`);
                    if (worksheets.length === 0) {
                         console.warn("No worksheets found on dashboard:", dashboard.name);
                         return;
                    }
                    const filterPromises = worksheets.map(ws => 
                        ws.applyFilterAsync(fieldName, values, updateType)
                    );
                    return Promise.allSettled(filterPromises); 
                } catch (e) {
                    console.error("Error in applyToDashboardWorksheets:", e);
                }
            }

            async function clearDashboardWorksheetsFilter(workbookObj, fieldName) {
                 try {
                    const dashboard = workbookObj.activeSheet;
                    const worksheets = dashboard.worksheets; 
                    console.log(`...Clearing filter from ${worksheets.length} sheets on dashboard ${dashboard.name}`);
                    if (worksheets.length === 0) {
                         console.warn("No worksheets found on dashboard:", dashboard.name);
                         return;
                    }
                    const clearPromises = worksheets.map(ws => 
                        ws.clearFilterAsync(fieldName)
                    );
                    return Promise.allSettled(clearPromises);
                } catch (e) {
                    console.error("Error in clearDashboardWorksheetsFilter:", e);
                }
            }
        
            async function handleFilterChange(group, isInit = false) {
                if (!viz1Ready || !viz2Ready) return;
                
                if (!isInit) {
                     await new Promise(r => setTimeout(r, 500)); // Delay for user clicks
                }

                const fieldName = group.dataset.fieldName;
                const allCb = group.querySelector(".filter-all-cb");
                const checkboxes = group.querySelectorAll("input[type='checkbox']:not(.filter-all-cb)");
                const selectedValues = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
        
                console.log(`Handling filter change for: ${fieldName}`);
                try {
                    // --- CHANGED: New (All) logic ---
                    if (allCb.checked) {
                         // (All) is checked, apply ALL values
                        const allValues = Array.from(checkboxes).map(cb => cb.value);
                        console.log(`...Applying ALL ${allValues.length} values.`);
                        if(allValues.length > 0) {
                             await Promise.allSettled([
                                applyToDashboardWorksheets(vizObj1, fieldName, allValues, "replace"),
                                applyToDashboardWorksheets(vizObj2, fieldName, allValues, "replace")
                            ]);
                        }
                    } else if (selectedValues.length > 0) {
                        // --- APPLY SPECIFIC FILTERS ---
                        console.log(`...Applying values: ${JSON.stringify(selectedValues)}`);
                        await Promise.allSettled([
                            applyToDashboardWorksheets(vizObj1, fieldName, selectedValues, "replace"),
                            applyToDashboardWorksheets(vizObj2, fieldName, selectedValues, "replace")
                        ]);
                    } else {
                        // --- (All) is unchecked and 0 selected, so clear filter ---
                        console.log(`...No values selected. Clearing filter.`);
                        await Promise.allSettled([
                            clearDashboardWorksheetsFilter(vizObj1, fieldName),
                            clearDashboardWorksheetsFilter(vizObj2, fieldName)
                        ]);
                    }
                    console.log(`Filter change complete for ${fieldName}.`);
                } catch (err) {
                    console.error(`Error applying filter ${fieldName}:`, err);
                }
            }
        
            // --- CHANGED: New "Clear All" logic ---
            async function handleClearAll() {
                if (!viz1Ready || !viz2Ready) return;
                console.log("Resetting all filters & parameters to default...");

                // 1. Revert Viz 1 to its published state. This is fast.
                try {
                    await vizObj1.revertAllAsync();
                    console.log("Viz 1 reverted to default.");
                } catch (e) {
                    console.error("Error reverting Viz 1:", e);
                    return; // Stop if revert fails
                }
                
                // 2. Reset HTML parameter controls
                allParamInputs.forEach(inp => {
                    if (inp.type === "checkbox") inp.checked = false;
                    if (inp.type === "date") inp.value = "";
                });
                
                // 3. Re-run the default sync logic. This will:
                //    - Read the new (default) state from Viz 1.
                //    - Update the HTML filter checkboxes.
                //    - Sync that default state to Viz 2.
                //    - Sync the reset parameters to both.
                await syncDefaults();
                
                console.log("All filters and parameters reset.");
            }
        
            // ------------------------------------------------------------------
            // ---------------------- PARAMETER HANDLING ------------------------
            // ------------------------------------------------------------------
        
            async function handleParamChange(input, skipDelay = false) {
                if (!viz1Ready || !viz2Ready) return;
                if (!skipDelay) await new Promise(r => setTimeout(r, 300));
        
                const paramName = input.dataset.paramName;
                let value;
        
                if (input.type === "checkbox") {
                    if (paramName === "Use Custom Range?") {
                        value = input.checked ? "Custom Range View" : "Standard View (FY)";
                    } else if (paramName === "Use Manual Date?") {
                        value = input.checked ? "Yes" : "No-Keep Default";
                    } else {
                        value = input.checked; // Send boolean for any others
                    }
                } else {
                    value = input.value; // Send date string
                }
        
                console.log(`Changing parameter: ${paramName} = ${value} (Type: ${typeof value})`);

                // Helper to check if param exists before changing
                async function tryChange(workbook, pName, pValue) {
                    try {
                        const params = await workbook.getParametersAsync();
                        const exists = params.some(p => p.name === pName);
                        
                        if (exists) {
                            await workbook.changeParameterValueAsync(pName, pValue);
                        } else {
                            console.log(`Parameter ${pName} does not exist on ${workbook.name}, skipping.`);
                        }
                    } catch (e) {
                        console.warn(`Parameter ${pName} not applied on one viz:`, e.message);
                    }
                }
        
                await Promise.allSettled([
                    tryChange(vizObj1, paramName, value), 
                    tryChange(vizObj2, paramName, value)
                ]);
            }
        
            // ------------------------------------------------------------------
            // ---------------------- INITIALIZATION ----------------------------
            // ------------------------------------------------------------------

            // --- CHANGED: Split init logic from sync logic ---
            function wireUpEventListeners() {
                console.log("Wiring up event listeners...");
                allFilterGroups.forEach(group => {
                    const allCb = group.querySelector(".filter-all-cb");
                    const others = group.querySelectorAll("input[type='checkbox']:not(.filter-all-cb)");

                    // Listener for the (All) checkbox
                    allCb.addEventListener("change", () => {
                        const isChecked = allCb.checked;
                        others.forEach(cb => cb.checked = isChecked); // Set all others to match
                        handleFilterChange(group, false); // false = not init
                    });

                    // Listeners for all other checkboxes
                    others.forEach(cb => {
                        cb.addEventListener("change", () => {
                            // Check if all are checked
                            const allOthersChecked = Array.from(others).every(c => c.checked);
                            allCb.checked = allOthersChecked; // Sync (All) checkbox
                            handleFilterChange(group, false); // false = not init
                        });
                    });
                });
        
                // Parameter listeners
                allParamInputs.forEach(input => {
                    input.addEventListener("change", () => handleParamChange(input, false)); // false = not init
                });
        
                clearAllButton.addEventListener("click", handleClearAll);
            }

            // --- CHANGED: New function to sync state ---
            async function syncDefaults() {
                console.log("Syncing defaults, filters, params...");
                
                // --- Read default filters from Viz 1 (robustly) ---
                try {
                    console.log("Attempting to read default filters from Viz 1...");
                    const dashboard = vizObj1.activeSheet;
                    const worksheets = dashboard.worksheets || [];
                    if (!worksheets.length) throw new Error("No worksheets found on dashboard.");
        
                    const appliedFilterMap = new Map();
                    for (const ws of worksheets) {
                        console.log(`...checking filters on sheet ${ws.name}`);
                        const filters = await ws.getFiltersAsync();
                        for (const f of filters) {
                            if (f.filterType === 'categorical' && !f.isAll) {
                                const values = f.appliedValues.map(v => v.value);
                                appliedFilterMap.set(f.fieldName, values);
                            }
                        }
                    }
                    console.log("Found applied filters:", appliedFilterMap);
                    
                    // --- Store this for 'Clear Filters' button ---
                    defaultFilterState = new Map(appliedFilterMap);

                    // Now update the HTML based on the map
                    allFilterGroups.forEach(group => {
                        const fName = group.dataset.fieldName;
                        const allCb = group.querySelector(".filter-all-cb");
                        const others = group.querySelectorAll("input[type='checkbox']:not(.filter-all-cb)");

                        if (appliedFilterMap.has(fName)) {
                            const applied = appliedFilterMap.get(fName);
                            if (applied.length > 0) {
                                console.log(`Setting default filter for ${fName}:`, applied);
                                others.forEach(cb => {
                                    cb.checked = applied.includes(cb.value);
                                });
                                allCb.checked = Array.from(others).every(c => c.checked);
                            } else {
                                console.log(`Filter ${fName} was found but empty, setting to (All).`);
                                allCb.checked = true;
                                others.forEach(cb => cb.checked = true);
                            }
                        } else {
                            console.log(`No default filter found for ${fName}, setting to (All).`);
                            allCb.checked = true;
                            others.forEach(cb => cb.checked = true);
                        }
                    });
        
                } catch (e) {
                    console.warn("Could not read default filters, defaulting to (All):", e.message);
                    // Fallback
                    allFilterGroups.forEach(group => {
                        group.querySelector(".filter-all-cb").checked = true;
                        group.querySelectorAll("input[type='checkbox']:not(.filter-all-cb)").forEach(cb => cb.checked = true);
                    });
                }
                
                // --- Sync the newly set HTML defaults to Viz 2 ---
                console.log("Syncing default filters to Viz 2...");
                const filterSyncPromises = [];
                for (const group of allFilterGroups) {
                    // Read the state we just set in the HTML
                    const fieldName = group.dataset.fieldName;
                    const allCb = group.querySelector(".filter-all-cb");
                    const checkboxes = group.querySelectorAll("input[type='checkbox']:not(.filter-all-cb)");
                    const selectedValues = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    if (allCb.checked) {
                        const allValues = Array.from(checkboxes).map(cb => cb.value);
                        if(allValues.length > 0){
                            filterSyncPromises.push(applyToDashboardWorksheets(vizObj2, fieldName, allValues, "replace"));
                        }
                    } else if (selectedValues.length > 0) {
                        filterSyncPromises.push(applyToDashboardWorksheets(vizObj2, fieldName, selectedValues, "replace"));
                    } else {
                         filterSyncPromises.push(clearDashboardWorksheetsFilter(vizObj2, fieldName));
                    }
                }
                await Promise.allSettled(filterSyncPromises);
                console.log("Viz 2 filters synced.");
        
                // Sync parameter defaults from current HTML state
                console.log("Syncing default parameters...");
                const paramPromises = [];
                allParamInputs.forEach(input => {
                    if ((input.type === "checkbox" && input.checked) || (input.type === "date" && input.value)) {
                        paramPromises.push(handleParamChange(input, true)); // true = skipDelay
                    }
                });
                await Promise.allSettled(paramPromises);
        
                console.log("Initialization/Sync complete.");
            }

            // --- Main application start ---
            async function initializeApp() {
                console.log("Both vizzes ready. Wiring listeners and syncing defaults.");
                wireUpEventListeners(); // Run this once
                await syncDefaults(); // Run this now
            }
        
            // --- Viz readiness ---
            viz1.addEventListener("firstinteractive", async () => {
                console.log("Viz 1 is ready.");
                vizObj1 = viz1.workbook;
                viz1Ready = true;
                if (viz2Ready) await initializeApp();
            });
        
            viz2.addEventListener("firstinteractive", async () => {
                console.log("Viz 2 is ready.");
                vizObj2 = viz2.workbook;
                viz2Ready = true;
                if (viz1Ready) await initializeApp();
            });
        });
    </script>
</body>
</html>